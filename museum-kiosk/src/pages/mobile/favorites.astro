---
import MobileLayout from '../../layouts/MobileLayout.astro';
import { getCollection } from 'astro:content';

// Get all exhibits for client-side rendering
const allExhibits = await getCollection('exhibits');
---

<MobileLayout title="Favoriten - Museum Gr√ºnes Haus" activeTab="favorites">
  <div class="mobile-page">
    <!-- Clean Header -->
    <div class="mobile-header">
      <h1>‚ù§Ô∏è Meine Favoriten</h1>
    </div>

    <!-- Clean Content -->
    <div class="mobile-content">
      <!-- Favorites List Container -->
      <div id="favorites-container" class="favorites-container">
        <div class="clean-empty" id="loading-state">
          <div class="clean-empty-icon">‚è≥</div>
          <p class="clean-empty-text">Lade Favoriten...</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="clean-empty" style="display: none;">
        <div class="clean-empty-icon">üíî</div>
        <h2 class="clean-section-title">Keine Favoriten</h2>
        <p class="clean-empty-text">Speichern Sie Exponate, die Sie interessieren, indem Sie auf das Herz-Symbol tippen.</p>
        <a href="/mobile/exhibits" class="clean-btn clean-btn-primary">Exponate durchsuchen</a>
      </div>

      <!-- Export Options -->
      <section id="export-options" class="clean-section" style="display: none;">
        <h2 class="clean-section-title">Liste teilen</h2>
        <div class="clean-card">
          <div class="export-options">
            <button id="share-list" class="clean-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
              </svg>
              Liste teilen
            </button>
            <button id="export-pdf" class="clean-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
              Als PDF exportieren
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>
</MobileLayout>

<style>
  /* Favorites specific components */
  .favorites-container {
    margin-bottom: var(--space-8);
  }

  .favorite-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    text-decoration: none;
    color: var(--color-primary);
    position: relative;
    transition: var(--transition);
  }

  .favorite-item:hover {
    background: var(--color-bg-alt);
  }

  .favorite-item:active {
    background: var(--color-border);
  }

  .favorite-item:last-child {
    border-bottom: none;
  }

  .favorite-link {
    display: flex;
    flex: 1;
    gap: var(--space-4);
    text-decoration: none;
    color: inherit;
    align-items: center;
  }

  .favorite-image {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-md);
    background: var(--color-bg-alt);
    overflow: hidden;
    flex-shrink: 0;
  }

  .favorite-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .favorite-info {
    flex: 1;
    min-width: 0;
  }

  .favorite-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    margin: 0 0 var(--space-1) 0;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .favorite-artist {
    font-size: var(--font-size-sm);
    color: var(--color-secondary);
    margin: 0 0 var(--space-1) 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .favorite-location {
    font-size: var(--font-size-xs);
    color: var(--color-tertiary);
  }

  .remove-btn {
    width: 44px;
    height: 44px;
    background: transparent;
    border: 2px solid var(--color-error);
    border-radius: 50%;
    color: var(--color-error);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: var(--font-size-lg);
    flex-shrink: 0;
  }

  .remove-btn:hover {
    background: var(--color-error);
    color: white;
  }

  .remove-btn:active {
    transform: scale(0.95);
  }

  /* Export options */
  .export-options {
    display: flex;
    gap: var(--space-4);
  }

  .export-options .clean-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
  }

  /* Animation for removal */
  .favorite-item.removing {
    animation: slideOut 0.3s ease-out forwards;
  }

  @keyframes slideOut {
    to {
      transform: translateX(-100%);
      opacity: 0;
    }
  }

  /* Empty state adjustments */
  .clean-empty h2 {
    color: var(--color-primary);
    margin-bottom: var(--space-4);
  }

  .clean-empty .clean-btn {
    margin-top: var(--space-4);
  }
</style>

<script define:vars={{ allExhibits }}>
  // Load favorites from localStorage
  function loadFavorites() {
    const container = document.getElementById('favorites-container');
    const emptyState = document.getElementById('empty-state');
    const exportOptions = document.getElementById('export-options');
    const loadingState = document.getElementById('loading-state');
    
    const favoriteIds = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    // Hide loading state
    if (loadingState) loadingState.style.display = 'none';
    
    if (favoriteIds.length === 0) {
      if (container) container.style.display = 'none';
      if (emptyState) emptyState.style.display = 'block';
      if (exportOptions) exportOptions.style.display = 'none';
      return;
    }
    
    // Filter exhibits that are in favorites
    const favoriteExhibits = allExhibits.filter(exhibit => 
      favoriteIds.includes(exhibit.slug)
    );
    
    // Render favorites
    if (container) {
      container.innerHTML = `
        <div class="clean-card">
          <div class="clean-list">
            ${favoriteExhibits.map(exhibit => `
              <div class="favorite-item" data-slug="${exhibit.slug}">
                <a href="/mobile/exhibit/${exhibit.slug}" class="favorite-link">
                  <div class="favorite-image">
                    <img src="${exhibit.data.thumbnail || exhibit.data.image}" alt="${exhibit.data.title}" loading="lazy" />
                  </div>
                  <div class="favorite-info">
                    <h3 class="favorite-title">${exhibit.data.title}</h3>
                    <p class="favorite-artist">${exhibit.data.artist}</p>
                    ${exhibit.data.location ? `<div class="favorite-location">üìç ${exhibit.data.location}</div>` : ''}
                  </div>
                </a>
                <button class="remove-btn" data-slug="${exhibit.slug}" aria-label="Aus Favoriten entfernen">
                  √ó
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      // Add remove handlers
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const slug = (e.currentTarget as HTMLElement).getAttribute('data-slug');
          if (slug) removeFavorite(slug);
        });
      });
    }
    
    if (emptyState) emptyState.style.display = 'none';
    if (exportOptions) exportOptions.style.display = 'block';
  }
  
  // Remove favorite
  function removeFavorite(slug: string) {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const index = favorites.indexOf(slug);
    
    if (index > -1) {
      // Animate removal
      const item = document.querySelector(`.favorite-item[data-slug="${slug}"]`);
      if (item) {
        item.classList.add('removing');
        
        setTimeout(() => {
          // Update localStorage
          favorites.splice(index, 1);
          localStorage.setItem('favorites', JSON.stringify(favorites));
          
          // Reload list
          loadFavorites();
        }, 300);
      }
    }
  }
  
  // Share list
  document.getElementById('share-list')?.addEventListener('click', async () => {
    const favoriteIds = JSON.parse(localStorage.getItem('favorites') || '[]');
    const favoriteExhibits = allExhibits.filter(exhibit => 
      favoriteIds.includes(exhibit.slug)
    );
    
    const text = `Meine Favoriten aus dem Museum Gr√ºnes Haus:\n\n${
      favoriteExhibits.map(e => `‚Ä¢ ${e.data.title} - ${e.data.artist}`).join('\n')
    }`;
    
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'Meine Museums-Favoriten',
          text: text,
          url: window.location.origin
        });
      } catch (err) {
        console.log('Share failed:', err);
      }
    } else {
      // Fallback: copy to clipboard
      await navigator.clipboard.writeText(text);
      alert('Liste wurde in die Zwischenablage kopiert!');
    }
  });
  
  // Export as PDF (mock)
  document.getElementById('export-pdf')?.addEventListener('click', () => {
    const favoriteIds = JSON.parse(localStorage.getItem('favorites') || '[]');
    const favoriteExhibits = allExhibits.filter(exhibit => 
      favoriteIds.includes(exhibit.slug)
    );
    
    // In a real app, generate PDF with jsPDF or similar
    const content = favoriteExhibits.map(e => 
      `${e.data.title}\n${e.data.artist}\n${e.data.year || ''}\n---`
    ).join('\n\n');
    
    // Mock download
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'museum-favoriten.txt';
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Ihre Favoriten wurden heruntergeladen!');
  });
  
  // Initialize
  loadFavorites();
</script>
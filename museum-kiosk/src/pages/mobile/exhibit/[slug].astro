---
import { getCollection, getEntry } from 'astro:content';
import MobileLayout from '../../../layouts/MobileLayout.astro';

// Get slug from params for SSR
const { slug } = Astro.params;

// Get the exhibit
const exhibit = await getEntry('exhibits', slug);

if (!exhibit) {
  return Astro.redirect('/mobile/exhibits');
}

const { Content } = await exhibit.render();

// Get related persons
const persons = await getCollection('persons');
const relatedPersons = persons.filter(person => 
  exhibit.data.relatedPersons?.includes(person.slug)
);
---

<MobileLayout title={`${exhibit.data.title} - Museum Gr√ºnes Haus`}>
  <article class="exhibit-detail world-class-page">
    <!-- Hero Image -->
    <div class="exhibit-hero image-container">
      <img src={exhibit.data.image} alt={exhibit.data.title} class="hero-image ken-burns-subtle" />
      <div class="hero-overlay glass-dark"></div>
      <div class="hero-actions">
        <button class="action-btn favorite-btn museum-button" id="favorite-btn" aria-label="Zu Favoriten hinzuf√ºgen">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </button>
        <button class="action-btn share-btn museum-button" id="share-btn" aria-label="Teilen">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Main Info -->
    <div class="exhibit-header museum-card">
      <h1 class="museum-display exhibit-title">{exhibit.data.title}</h1>
      <p class="museum-heading artist-name">{exhibit.data.artist}</p>
      <p class="museum-caption year-info">{exhibit.data.year}</p>
    </div>

    <!-- Quick Facts -->
    <div class="quick-facts museum-card glass-premium">
      {exhibit.data.technique && (
        <div class="fact">
          <span class="fact-label museum-caption">Technik</span>
          <span class="fact-value museum-body">{exhibit.data.technique}</span>
        </div>
      )}
      {exhibit.data.dimensions && (
        <div class="fact">
          <span class="fact-label museum-caption">Ma√üe</span>
          <span class="fact-value museum-body">{exhibit.data.dimensions}</span>
        </div>
      )}
      {exhibit.data.location && (
        <div class="fact">
          <span class="fact-label museum-caption">Standort</span>
          <span class="fact-value museum-body">{exhibit.data.location}</span>
        </div>
      )}
    </div>

    <!-- Audio Guide -->
    {exhibit.data.audioGuide && (
      <div class="audio-guide museum-card">
        <h2 class="museum-heading audio-title">
          <span class="audio-icon">üéß</span>
          Audio-Guide
        </h2>
        <div class="audio-player">
          <audio controls src={exhibit.data.audioGuide} preload="none" class="premium-audio">
            Ihr Browser unterst√ºtzt kein Audio.
          </audio>
        </div>
      </div>
    )}

    <!-- Description -->
    <div class="exhibit-content museum-card">
      <div class="content-wrapper museum-body">
        <Content />
      </div>
    </div>

    <!-- Related Persons -->
    {relatedPersons.length > 0 && (
      <div class="related-section">
        <h2>√úber den K√ºnstler</h2>
        {relatedPersons.map(person => (
          <a href={`/mobile/person/${person.slug}`} class="related-card">
            <div class="related-image">
              {person.data.portrait && (
                <img src={person.data.portrait} alt={person.data.name} />
              )}
            </div>
            <div class="related-info">
              <h3>{person.data.name}</h3>
              <p>{person.data.lifespan}</p>
              <p class="related-link">Mehr erfahren ‚Üí</p>
            </div>
          </a>
        ))}
      </div>
    )}

    <!-- Tags -->
    {exhibit.data.tags && exhibit.data.tags.length > 0 && (
      <div class="tags">
        {exhibit.data.tags.map(tag => (
          <span class="tag">#{tag}</span>
        ))}
      </div>
    )}

    <!-- Related Exhibits -->
    <div class="more-section">
      <h2>Weitere Exponate entdecken</h2>
      <div class="more-grid">
        <a href="/mobile/exhibits" class="more-btn">
          <span class="more-icon">üñºÔ∏è</span>
          <span>Alle Exponate</span>
        </a>
        <a href="/mobile/scan" class="more-btn">
          <span class="more-icon">üì∑</span>
          <span>QR Scanner</span>
        </a>
      </div>
    </div>
  </article>
</MobileLayout>

<style>
  .exhibit-detail {
    background: var(--museum-white);
    min-height: 100vh;
    animation: pageEnter 0.6s var(--ease-out-expo);
  }

  .world-class-page {
    container-type: inline-size;
  }

  /* Hero Image - World Class */
  .exhibit-hero {
    position: relative;
    width: 100%;
    height: 70vh;
    max-height: 600px;
    overflow: hidden;
    margin-bottom: var(--space-21);
  }

  .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: var(--museum-gray-100);
    filter: brightness(1.05) contrast(1.1) saturate(1.1);
  }

  .hero-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40%;
    background: linear-gradient(
      transparent 0%,
      rgba(0,0,0,0.4) 70%,
      rgba(0,0,0,0.8) 100%
    );
    pointer-events: none;
  }

  .hero-actions {
    position: absolute;
    top: var(--space-21);
    right: var(--space-21);
    display: flex;
    gap: var(--space-13);
  }

  .action-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: all 0.3s var(--ease-out-expo);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: var(--shadow-lg);
    transform: translateZ(0);
    will-change: transform;
  }

  .action-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-xl);
  }

  .action-btn:active {
    transform: scale(0.95);
  }

  .favorite-btn.active {
    background: linear-gradient(135deg, var(--moma-red), var(--guggenheim-purple));
    color: white;
  }

  .favorite-btn.active svg {
    fill: currentColor;
  }

  /* Header - World Class */
  .exhibit-header {
    padding: var(--space-34) var(--space-21);
    margin: 0 var(--space-21) var(--space-21);
    overflow: hidden;
    position: relative;
  }

  .exhibit-title {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-13);
    color: var(--museum-black);
    line-height: 1.1;
  }

  .artist-name {
    font-size: var(--text-lg);
    color: var(--museum-gray-600);
    margin-bottom: var(--space-8);
    font-weight: 500;
  }

  .year-info {
    color: var(--tate-turquoise);
    font-weight: 600;
  }

  /* Quick Facts - World Class */
  .quick-facts {
    margin: 0 var(--space-21) var(--space-21);
    padding: var(--space-21);
    display: flex;
    flex-direction: column;
    gap: var(--space-13);
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
  }

  .fact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-8) 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .fact:last-child {
    border-bottom: none;
  }

  .fact-label {
    font-weight: 600;
    color: var(--museum-gray-700);
  }

  .fact-value {
    text-align: right;
    font-weight: 500;
    color: var(--museum-black);
  }

  /* Audio Guide - World Class */
  .audio-guide {
    margin: 0 var(--space-21) var(--space-21);
    padding: var(--space-21);
    background: linear-gradient(135deg, var(--tate-turquoise), var(--pompidou-blue));
    color: white;
    overflow: hidden;
    position: relative;
  }

  .audio-title {
    display: flex;
    align-items: center;
    gap: var(--space-8);
    font-size: var(--text-lg);
    margin-bottom: var(--space-13);
    color: white;
  }

  .audio-icon {
    font-size: var(--text-xl);
  }

  .audio-player {
    position: relative;
  }

  .premium-audio {
    width: 100%;
    height: 56px;
    border-radius: var(--radius-lg);
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
  }

  /* Content - World Class */
  .exhibit-content {
    margin: 0 var(--space-21) var(--space-21);
    padding: var(--space-34) var(--space-21);
    overflow: hidden;
    position: relative;
  }

  .content-wrapper {
    line-height: 1.7;
    color: var(--museum-gray-800);
    font-size: var(--text-base);
  }

  .exhibit-content :global(h2) {
    font-family: 'Playfair Display', serif;
    font-size: var(--text-xl);
    font-weight: 700;
    margin-top: var(--space-34);
    margin-bottom: var(--space-13);
    color: var(--museum-black);
    letter-spacing: -0.02em;
  }

  .exhibit-content :global(h3) {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-top: var(--space-21);
    margin-bottom: var(--space-8);
    color: var(--museum-gray-800);
  }

  .exhibit-content :global(p) {
    margin-bottom: var(--space-21);
  }

  .exhibit-content :global(ul),
  .exhibit-content :global(ol) {
    margin: var(--space-21) 0;
    padding-left: var(--space-21);
  }

  .exhibit-content :global(li) {
    margin-bottom: var(--space-8);
  }

  .exhibit-content :global(strong) {
    color: var(--museum-black);
    font-weight: 600;
  }

  .exhibit-content :global(em) {
    font-style: italic;
    color: var(--museum-gray-700);
  }

  .exhibit-content :global(blockquote) {
    margin: var(--space-21) 0;
    padding: var(--space-21);
    border-left: 4px solid var(--pinakothek-gold);
    background: linear-gradient(135deg, var(--museum-gray-100), var(--museum-gray-200));
    border-radius: var(--radius-md);
    font-style: italic;
    position: relative;
  }

  /* Related Section - World Class */
  .related-section {
    margin: 0 var(--space-21) var(--space-21);
    padding: var(--space-21);
    background: var(--museum-gray-100);
    border-radius: var(--radius-lg);
  }

  .related-section h2 {
    font-family: 'Playfair Display', serif;
    font-size: var(--text-lg);
    font-weight: 700;
    margin-bottom: var(--space-13);
    color: var(--museum-black);
  }

  .related-card {
    display: flex;
    gap: var(--space-13);
    padding: var(--space-21);
    background: var(--museum-white);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: var(--museum-black);
    transition: all 0.3s var(--ease-out-expo);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    position: relative;
  }

  .related-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .related-card:active {
    transform: scale(0.98);
  }

  .related-image {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    overflow: hidden;
    background: var(--museum-gray-200);
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }

  .related-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s var(--ease-out-expo);
  }

  .related-card:hover .related-image img {
    transform: scale(1.05);
  }

  .related-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .related-info h3 {
    font-size: var(--text-base);
    font-weight: 600;
    margin-bottom: var(--space-2);
    color: var(--museum-black);
  }

  .related-info p {
    font-size: var(--text-sm);
    color: var(--museum-gray-600);
    margin-bottom: var(--space-2);
  }

  .related-link {
    color: var(--tate-turquoise) !important;
    font-size: var(--text-xs) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
  }

  /* Tags - World Class */
  .tags {
    padding: 0 var(--space-21) var(--space-21);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-8);
  }

  .tag {
    padding: var(--space-5) var(--space-13);
    background: linear-gradient(135deg, var(--museum-gray-100), var(--museum-gray-200));
    color: var(--museum-gray-700);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 500;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    transition: all 0.2s var(--ease-out-expo);
    border: 1px solid rgba(255,255,255,0.8);
  }

  .tag:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  /* More Section - World Class */
  .more-section {
    padding: var(--space-34) var(--space-21);
    background: var(--museum-white);
    border-top: 1px solid var(--museum-gray-200);
    margin-top: var(--space-34);
  }

  .more-section h2 {
    font-family: 'Playfair Display', serif;
    font-size: var(--text-lg);
    font-weight: 700;
    margin-bottom: var(--space-21);
    color: var(--museum-black);
    text-align: center;
  }

  .more-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-13);
  }

  .more-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-21);
    background: linear-gradient(135deg, var(--museum-gray-100), var(--museum-gray-200));
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: var(--museum-black);
    transition: all 0.3s var(--ease-out-expo);
    min-height: 120px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.5);
    backdrop-filter: blur(10px);
  }

  .more-btn:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, var(--museum-white), var(--museum-gray-100));
  }

  .more-btn:active {
    transform: translateY(-2px) scale(0.98);
  }

  .more-icon {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-8);
    transition: transform 0.3s var(--ease-out-expo);
  }

  .more-btn:hover .more-icon {
    transform: scale(1.1);
  }

  .more-btn span:last-child {
    font-size: var(--text-sm);
    font-weight: 500;
    letter-spacing: 0.025em;
  }

  /* Responsive Adjustments */
  @container (max-width: 480px) {
    .hero-actions {
      top: var(--space-13);
      right: var(--space-13);
      gap: var(--space-8);
    }
    
    .action-btn {
      width: 44px;
      height: 44px;
    }
    
    .exhibit-title {
      font-size: var(--text-xl);
    }
    
    .more-grid {
      grid-template-columns: 1fr;
      gap: var(--space-8);
    }
  }
  
  /* Touch Interactions */
  @media (hover: none) {
    .action-btn:hover {
      transform: none;
    }
    
    .related-card:hover {
      transform: none;
    }
    
    .more-btn:hover {
      transform: none;
      background: linear-gradient(135deg, var(--museum-gray-100), var(--museum-gray-200));
    }
  }
  
  /* Dark Mode Support */
  @media (prefers-color-scheme: dark) {
    .exhibit-detail {
      background: var(--museum-black);
    }
    
    .hero-overlay {
      background: linear-gradient(
        transparent 0%,
        rgba(255,255,255,0.1) 70%,
        rgba(255,255,255,0.2) 100%
      );
    }
  }
</style>

<script define:vars={{ exhibitId: exhibit.slug }}>
  // Favorites functionality
  const favoriteBtn = document.getElementById('favorite-btn');
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  const isFavorite = favorites.includes(exhibitId);
  
  if (isFavorite) {
    favoriteBtn?.classList.add('active');
  }
  
  favoriteBtn?.addEventListener('click', () => {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const index = favorites.indexOf(exhibitId);
    
    if (index > -1) {
      favorites.splice(index, 1);
      favoriteBtn.classList.remove('active');
    } else {
      favorites.push(exhibitId);
      favoriteBtn.classList.add('active');
    }
    
    localStorage.setItem('favorites', JSON.stringify(favorites));
  });
  
  // Share functionality
  const shareBtn = document.getElementById('share-btn');
  shareBtn?.addEventListener('click', async () => {
    const shareData = {
      title: document.title,
      text: 'Entdecken Sie dieses Exponat im Museum Gr√ºnes Haus',
      url: window.location.href
    };
    
    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        // Fallback: Copy to clipboard
        await navigator.clipboard.writeText(window.location.href);
        alert('Link kopiert!');
      }
    } catch (err) {
      console.log('Share failed:', err);
    }
  });
</script>